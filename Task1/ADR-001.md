# ADR-001: Задание 1. Разработка вариантов решений
## Автор: Сурков Александр
## Дата: 23.07.2025
## 1. Контекст
Компания «АгроТех Х» давно работает на рынке, занимается выращиванием различных культур, имеет 150 тепличных комплексов по всей стране и занимается свиноводством. У компании есть свой собственный парк техники.

IT-ландшафт компании формировался постепенно, и там можно встретить как достаточно современные, так и совсем устаревшие технологии, от которых постепенно отказываются.

По мере развития IoT компания пробует различные датчики и системы в своей работе. Например, для парка техники внедрён мониторинг местоположения, состояния, расхода топлива, выполнения работ множества единиц техники (тракторы, комбайны, опрыскиватели) разных производителей для планирования заданий, сокращения издержек и повышения производительности.

Сейчас перед компанией стоит задача — повысить эффективность в сфере животноводства и по максимуму автоматизировать процессы, связанные с кормлением, безопасностью и мониторингом поголовья скота.

На рынке уже представлены продукты из этой сферы: это [PigVision](https://agrovision.com/uk/software/pigs/pigvision/), [ALUS](https://alus.ca/alus_news_and_events/aw-canada-cargill-build-nature-based-solutions-with-alus/) или [PigTales](https://www.boehringer-ingelheim.com/ca/animal-health/livestock/swine), есть различные исследования и проекты: https://blog.iotcloudplatform.com/how-to-design-an-iot-smart-pig-farming-system/ . Но купить и адаптировать их в настоящих реалиях не получится либо из-за ограничений в законодательстве, либо из-за дороговизны реализации. Например, использование дронов для мониторинга скота.

Поэтому решено сделать MVP архитектуры c нуля и запустить как отдельную платформу для мониторинга скота. Сначала планируется реализовать это на ограниченном количестве ферм, а затем потенциально предлагать как SaaS-решение для других компаний — это уже выходит за рамки проектной работы.

## 2. Требования
### Функциональные требования
| FR-ID    | Действующие лица или системы                                                                | Use Case                                                                                                                                                                                                                                    | Описание                                                                                                                                                                                                                                                         |
|----------|---------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| FR-001   | Животные, Система активности живодных, Оператор                                             | фиксировать признаки беспокойного поведения или драк среди животных и оповещать оператора                                                                                                                                                   | 1. Животное или группа животных изменяет свое обычное поведение<br>2. Система активности живодных распознает такие особенности<br>3. Оператору на рабочем месте высвечивается информация о событии<br>4. Оператор может подтвердить или отклонить событие        |
| FR-002   | Животные, Система активности живодных, Оператор                                             | фиксировать признаки задавливания поросят                                                                                                                                                                                                   | 1. Животное длительное время не перемещается<br>2. Система активности живодных распознает такие особенности<br>3. Оператору на рабочем месте высвечивается информация о событии<br>4. Оператор может подтвердить или отклонить событие                           |
| FR-003   | Оператор, Система автокормления                                                             | управлять кормушками разных производителей                                                                                                                                                                                                  | 1. Оператор настраивает автокормушки<br>2. Оператор утверджает изменения<br>3. Система автокрмления начинает работать в соответствии с заданными настройками                                                                                                     |
| FR-004   | Оператор, Система автопоилок                                                                | управлять поилками разных производителей                                                                                                                                                                                                    | 1. Оператор настраивает автопоилки<br>2. Оператор утверджает изменения<br>3. Система автопоилок начинает работать в соответствии с заданными настройками                                                                                                         |
| FR-005   | Животные, Система фиксации состояния животных, Система анализа состояния животных, Оператор | оценивать состояние животных по внешнему виду и поведению: болезнь, гибель, беспокойство и так далее                                                                                                                                        | 1. Система фиксации состояния живодных фиксирует показатели состояния животных<br>2. Система анализа состояния животных анализирует показатели<br>3. Если показатели отклоняются от нормативных Система анализа состояния животных  информирует об это Оператора |
| FR-006   | Система фиксации состояния воды, Система контроля состояния воды, Оператор                  | следить за состоянием систем фильтрации воды                                                                                                                                                                                                | 1. Датчики воды фиксируют показатели воды в Системе фиксации состояния воды<br>2. Система контроля состояния воды анализирует показатели воды<br>3. Если показатели воды отклоняются от тормативных Оператору сообщается об этом                                 |
| FR-007   | Система активности живодных, Система учета животных                                         | пересчитывать поголовье                                                                                                                                                                                                                     | 1. Система активности живодных собирает информацию о живых и мертвых животных<br>2. Система учета животных собирает информацию о поголовье                                                                                                                       |
| FR-008   | Система учета кормов, Система анализа расхода кормов, Система учета животных                | следить за запасами еды и прогнозировать расход                                                                                                                                                                                             | 1. Система учета кормов фиксирует пополнение и забор кормов<br>2. Система анализа расхода кормов взаимодействует с Система учета животных и делает прогноз по необходимому объему кормов                                                                         |
| FR-009   | Менеджер фермы                                                                              | поддерживать необходимое количество видеокамер для аналитики в реальном времени от разных производителей                                                                                                                                    | Менеджер площадки должен контролировать количество необходимых видеокамер и в случае их недостатка, выхода из строя связываться с отделом закупки.<br>Это требование напрямую не связано с разработкой системы.                                                  |
| FR-010   | Система синхронизации между агентами и центральным сервером                                 | быть построена по принципу «центральный сервер — агенты» на конкретных фермах без ограничения количества таких агентов (в синхронизации между агентами и центральным сервером допускается задержка до 10 минут без учёта проблем со связью) | Инфраструктура по сбору и текущему анализу данных изначально сохраняется на каждой ферме - агенте. Система синхронизации между агентами и центральным сервером передает данные с агента на центральный сервер                                                    |
| FR-011   | Система мониторинга агентов                                                                 | работать даже в случае отсутствия интернета и при необходимости отправлять уведомления дежурному сотруднику на местах мониторинга, а после восстановления связи синхронизироваться с центральной системой                                   | Система мониторинга агентов расположенная на центральных серверах мониторит доступность агентов и в случае сетевых сбоев информирует заинтересованных лиц. За передачу данных отвечает агент.                                                                    |
| FR-012   |                                                                                             | предоставлять базовые метрики для передачи в другие системы                                                                                                                                                                                 | Исходя из характера взаимодействия, когда агент передает в центральный сервис данные доступ к данным может быть предоставлен на чентральном сервисе                                                                                                              |
| FR-013   |                                                                                             | поддерживать возможность добавления собственных метрик                                                                                                                                                                                      | Необходимо обеспечить возможность добавлять метрики                                                                                                                                                                                                              |
| FR-014   |                                                                                             | иметь разделение ролей и поддерживать современные способы аутентификации и авторизации                                                                                                                                                      |                                                                                                                                                                                                                                                                  |
| FR-015   |                                                                                             | иметь API для создания мобильного приложения или веб-приложения                                                                                                                                                                             |                                                                                                                                                                                                                                                                  |

### Нефункциональные требования

| NFR-ID  | Требование                                                                                                                                                                         |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| NFR-001 | обеспечивать достаточно высокую отказоустойчивость 99,95%                                                                                                                          |
| NFR-002 | быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего                                                                               |
| NFR-003 | иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения |
| NFR-004 | позволять системе видеоаналитики реагировать в реальном времени (миллисекунды)                                                                                                     |

## 3. Решение
Диаграмма контекста в модели C4.

```plantuml
@startuml
!include https://raw.githubusercontent.com/SurkovAleksandr/MSA-AgroTech-sprint-1/refs/heads/master/Task1/C4_Context.puml
SHOW_PERSON_OUTLINE()

title Диаграмма контекста C4 системы AgroTech

Person(operator, "Оператор", "Пользователь системы AgroTech на ферме(агенте)")
Person(animal, "Животное", "Животное(поросенок) на ферме(агенте)")

System(agent_system, "Система мониторинга и автоматизации фермы(агент)", "Позволяет Оператору мониторить состояние животных и качество еды в режиме реального времени.")
System(center_system, "Центральная система мониторинга и автоматизации фермы", "Собирает информацию с агентов, мониторит их доступность. Основной цент анализа данных.")

System_Ext(mail_system, "E-mail система", "Отправка e-mail сообщений.")
System_Ext(sms_system, "SMS система", "Отправка SMS сообщений.")

Rel(operator, agent_system, "Использует, настраивает, мониторит", "HTTP")
Rel_R(animal, agent_system, "Передает данные о состоянии")
Rel_Neighbor(agent_system, center_system, "Передача данных")

Rel_Neighbor(center_system, mail_system, "Отправка e-mail")
Rel_U(center_system, sms_system, "Отправка SMS")
@enduml
```
Диаграмма контейнеров в модели C4.
```plantuml

```


```plantuml
@startuml Архитектура_АгроТех_Системы_v4

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

' === Участники ===
Person(директор, "Директор хозяйства", "Управление через веб-портал")
Person(агроном, "Агроном", "Использует мобильное приложение")
Person(тепличник, "Тепличный комплекс", "Управление теплицами")
Person(механик, "Механик", "Мониторинг техники")
Person(аналитик, "Аналитик", "Работа с BI-системой")

System_Boundary(платформа, "АгроПром Х - Цифровая платформа") {
    Container(веб_портал, "Веб-портал", "React", "Управление хозяйством")
    Container(мобильное_приложение, "Мобильное приложение", "Flutter", "Полевые работы")
    ContainerDb(erp, "ERP система (1С:Агро)", "1С", "Финансы, склад, кадры")
    
    Container_Boundary(тепличные_системы, "Тепличные комплексы") {
        Container(scada, "SCADA система", "Ignition", "Управление климатом")
        Container(тепличные_датчики, "Тепличные датчики", "Python", "Микроклимат, полив")
        Container(автополив, "Система автополива", "C++", "Управление орошением")
    }
    
    Container(kafka, "Брокер сообщений", "Apache Kafka", "Шина данных")
    
    Container_Boundary(iot_платформа, "IoT платформа") {
        Container(iot_шлюз, "IoT шлюз", "Node-RED", "Сбор данных с полей")
        Container(tsdb, "База временных рядов", "TimescaleDB", "Данные датчиков")
        Container(трекер_техники, "Трекер техники", "Java", "Мониторинг транспорта")
    }
    
    Container_Boundary(полевые_данные, "Данные с полей") {
        Container(метео_данные, "Метеостанции", "Python", "Погодные условия")
        Container(почва, "Датчики почвы", "Python", "Влажность, состав")
        Container(урожайность, "Мониторинг урожая", "Python", "Камера+ИИ на технике")
    }
    
    Container_Boundary(управление_техникой, "Управление техникой") {
        Container(планировщик, "Планировщик заданий", "Kotlin", "Распределение работ")
        Container(мониторинг_гсм, "Мониторинг ГСМ", "Go", "Контроль топлива")
        Container(диагностика, "Диагностика", "C#", "Состояние техники")
    }
    
    Container_Boundary(данные, "Хранилища данных") {
        ContainerDb(data_lake, "Data Lake", "MinIO", "Сырые данные (S3-совместимое)")
        ContainerDb(dwh, "Data Warehouse", "ClickHouse", "Структурированные данные")
    }
    
    Container(bi, "BI система", "Power BI", "Отчеты и визуализация")
    Container(аналитика, "Аналитический модуль", "Python+Spark", "Анализ эффективности")
}

' === Взаимосвязи ===
Rel(директор, веб_портал, "Использует")
Rel(агроном, мобильное_приложение, "Использует")
Rel(тепличник, scada, "Управляет")
Rel(механик, трекер_техники, "Мониторит")
Rel(аналитик, bi, "Анализирует")

' Центральная Kafka
Rel(iot_шлюз, kafka, "Публикует данные", "Kafka Protocol")
Rel(тепличные_датчики, kafka, "Публикует данные", "MQTT->Kafka")
Rel(трекер_техники, kafka, "Публикует позиции", "Kafka Protocol")
Rel(kafka, data_lake, "Сырые данные", "Kafka Connect+S3")
Rel(kafka, dwh, "Трансформированные данные", "ETL+Airflow")

' Тепличные системы
Rel(scada, kafka, "Публикует климат-данные", "OPC UA->Kafka")
Rel(автополив, scada, "Получает команды", "Modbus TCP")
Rel(тепличные_датчики, scada, "Передает данные", "LoRaWAN")

' Полевые данные
Rel(метео_данные, iot_шлюз, "Передает данные", "LoRaWAN")
Rel(почва, iot_шлюз, "Передает данные", "LoRaWAN")
Rel(урожайность, iot_шлюз, "Передает данные", "4G")

' Управление техникой
Rel(kafka, планировщик, "Поток задач", "Kafka Protocol")
Rel(мониторинг_гсм, dwh, "Сохраняет данные", "ETL")
Rel(диагностика, erp, "Передает данные о ремонтах", "REST API")

' Аналитика
Rel(data_lake, аналитика, "Доступ к сырым данным", "Spark")
Rel(dwh, аналитика, "Доступ к структурированным данным", "SQL")
Rel(аналитика, bi, "Передает отчеты", "ODBC")
Rel(аналитика, веб_портал, "Формирует рекомендации", "WebSocket")

' ERP интеграция
Rel(веб_портал, erp, "Синхронизация данных", "REST API")
Rel(erp, dwh, "Бизнес-данные", "ETL")
Rel(мобильное_приложение, kafka, "Полевые отчеты", "Kafka Protocol")

@enduml
```

Также опишите, какой логикой вы руководствовались в ходе принятия решений и выбора технологий. Не забывайте, что необходимо учесть все функциональные и нефункциональные требования.
## 4. Альтернативы
~~Опишите здесь наиболее важные альтернативные решения.~~
На первом этапе можно:
- ограничить количество датчиков. Например, не ставить на всех свиней
- ограничить типы датчиков. Например, использовать только RFID-метки и не использовать:
  - RFID-чипы - Имплантируемые чипы
  - RFID-считыватели - Фиксация проходов, кормления, сбора данных
  - системы сбора и анализа данных - Централизованное управление стадом, мониторинг здоровья и продуктивности
- не использовать системы автоматической настройки окружающей среды:
    - вентиляция
    - отопление
    - влажность
- не разрабатывать системы мониторинга здоровья свиней
- не разрабатывать систему мониторинга окружающей среды
- не разрабатывать системы анализа и прогнозирования на центральном сервере
- не разрабатывать системы использования ресурсов: вода, электричество, корм
Как результат это позволит уменьшить количество необходимого оборудования и разрабатываемых программных модулей. 

## 5. Недостатки, ограничения, риски

Подробно опишите здесь недостатки, ограничения и риски выбранного решения.


-------------------
